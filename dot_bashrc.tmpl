# Start chezmoi template - "dot_bashrc.tmpl"
{{- if eq .chezmoi.os "windows" -}}

# windows
# ripgrep profile
export RIPGREP_CONFIG_PATH="$USERPROFILE/.ripgreprc"
alias rg='rg --path-separator=//'

{{- else if eq .chezmoi.osRelease.id "debian" -}}

# debian

{{- include "dot_bashrc_debian" -}}
{{- end -}}

. "$HOME/.cargo/env"

# Prefer vi-style keybindings in Bash
set -o vi

export SUDO_EDITOR=$(which nvim || which vim || which vi)
export VISUAL=$(which nvim || which vim || which vi)
export EDITOR="$VISUAL"

# bat theme
export BAT_THEME="gruvbox-dark"

cat ~/bash_shell_hints
# echo zoxide path cd'd to 
export _ZO_ECHO=1

export PATH=$HOME/bin:$HOME/.local/bin:$HOME/.amp/bin:/usr/local/go/bin:$PATH
# see https://github.com/neovim/neovim/blob/master/INSTALL.md#install-from-package
export PATH="$PATH:/opt/nvim-linux-x86_64/bin"

# Reuse a single ssh-agent across shells (DIY)
AGENT_ENV="$HOME/.ssh/agent.env"
# Import saved agent env if present
if [ -f "$AGENT_ENV" ]; then
  . "$AGENT_ENV" >/dev/null 2>&1
fi
# If no usable agent, start a new one and persist its env
if ! ssh-add -l >/dev/null 2>&1; then
  rc=$?
  if [ $rc -eq 2 ] || [ -z "${SSH_AUTH_SOCK:-}" ] || [ ! -S "$SSH_AUTH_SOCK" ] || ! kill -0 "${SSH_AGENT_PID:-0}" 2>/dev/null; then
    eval "$(ssh-agent -s)" >/dev/null
    mkdir -p "$HOME/.ssh"
    {
      echo "export SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
      echo "export SSH_AGENT_PID=$SSH_AGENT_PID"
    } >"$AGENT_ENV"
    chmod 600 "$AGENT_ENV"
  fi
fi
# If agent has no identities, optionally add default key (no timeout by default)
if ! ssh-add -l >/dev/null 2>&1; then
  # exit code 1 usually means: agent present, no identities
  [ -t 0 ] && [ -f "$HOME/.ssh/id_ed25519" ] && ssh-add "$HOME/.ssh/id_ed25519"
fi

# Pico SDK paths - only export if directories exist
[ -d "$HOME/pico/pico-sdk" ] && export PICO_SDK_PATH=$HOME/pico/pico-sdk
[ -d "$HOME/pico/pico-examples" ] && export PICO_EXAMPLES_PATH=$HOME/pico/pico-examples
[ -d "$HOME/pico/pico-extras" ] && export PICO_EXTRAS_PATH=$HOME/pico/pico-extras
[ -d "$HOME/pico/pico-playground" ] && export PICO_PLAYGROUND_PATH=$HOME/pico/pico-playground


# https://github.com/ajeetdsouza/zoxide?tab=readme-ov-file#configuration
eval "$(zoxide init bash)"

# mcfly
export MCFLY_RESULTS=60
eval "$(mcfly init bash)"

# direnv
eval "$(direnv hook bash)"

# Bitwarden CLI helper (unlocks vault and reloads direnv to pick up secrets)
bw_unlock() {
  export BW_SESSION=$(bw unlock --raw)
  if [[ -n "$BW_SESSION" ]]; then
    echo "Bitwarden unlocked. Reloading direnv..."
    # direnv reload triggers ~/.envrc which calls load_api_keys
    direnv reload
  else
    echo "Failed to unlock Bitwarden"
  fi
}

bw_lock() {
  bw lock
  unset BW_SESSION
  direnv reload
}

# Source Bitwarden helper functions (shared with direnv)
# These are in ~/.config/direnv/lib/bitwarden.sh - single source of truth
if [ -f "$HOME/.config/direnv/lib/bitwarden.sh" ]; then
  source "$HOME/.config/direnv/lib/bitwarden.sh"
fi

# Aliases
alias lg='lazygit'
alias xselc='xsel -b -i'
alias xselp='xsel -b -o'

# Add npm global bin to PATH if it exists
[ -d "$HOME/.npm-global/bin" ] && export PATH=$HOME/.npm-global/bin:$PATH

# Claude Code
export ENABLE_LSP_TOOL=1  # temporary: enable experimental LSP tool

# Claude Code (Podman) helpers
export CLAUDE_PODMAN_IMAGE="${CLAUDE_PODMAN_IMAGE:-claude-code:latest}"
export CLAUDE_PODMAN_VOLUME="${CLAUDE_PODMAN_VOLUME:-claude_cli_data}"

_claude_podman_base() {
  local claude_args
  claude_args=$(printf '%q ' "$@")
  podman run --rm -it \
    --userns=keep-id \
    --user "$(id -u)":"$(id -g)" \
    -e HOME=/home/node \
    -v "${CLAUDE_PODMAN_VOLUME}:/home/node" \
    "$CLAUDE_PODMAN_IMAGE" \
    bash -lc "claude ${claude_args}"
}

claude_here() {
  local claude_args
  claude_args=$(printf '%q ' "$@")
  podman run --rm -it \
    --userns=keep-id \
    --user "$(id -u)":"$(id -g)" \
    -e HOME=/home/node \
    -v "${CLAUDE_PODMAN_VOLUME}:/home/node" \
    -v "$(pwd)":/home/node/project:rw \
    -w /home/node/project \
    "$CLAUDE_PODMAN_IMAGE" \
    bash -lc "claude ${claude_args}"
}
alias claude-here=claude_here

claude_dir() {
  local target_dir="."
  if [[ $# -gt 0 && "$1" != -* ]]; then
    target_dir="$1"
    shift
  fi
  local claude_args
  claude_args=$(printf '%q ' "$@")
  local resolved
  resolved=$(realpath "$target_dir")
  podman run --rm -it \
    --userns=keep-id \
    --user "$(id -u)":"$(id -g)" \
    -e HOME=/home/node \
    -v "${CLAUDE_PODMAN_VOLUME}:/home/node" \
    -v "${resolved}:/home/node/project:rw" \
    -w /home/node/project \
    "$CLAUDE_PODMAN_IMAGE" \
    bash -lc "claude ${claude_args}"
}
alias claude-dir=claude_dir

claude_ask() {
  _claude_podman_base "$@"
}
alias claude-ask=claude_ask


# Connect IQ SDK
export CONNECTIQ_SDK_HOME="$HOME/.Garmin/ConnectIQ/Sdks/connectiq-sdk-lin-8.1.1-2025-03-27-66dae750f"
export PATH="$CONNECTIQ_SDK_HOME/bin:$PATH"

# fnm (resolve path relative to current user)
if [ -n "$XDG_DATA_HOME" ] && [ -d "$XDG_DATA_HOME/fnm" ]; then
  FNM_PATH="$XDG_DATA_HOME/fnm"
elif [ -d "$HOME/.local/share/fnm" ]; then
  FNM_PATH="$HOME/.local/share/fnm"
elif [ -d "$HOME/.fnm" ]; then
  FNM_PATH="$HOME/.fnm"
else
  FNM_PATH="$HOME/.local/share/fnm"
fi
if [ -d "$FNM_PATH" ]; then
  export PATH="$FNM_PATH:$PATH"
  eval "$(fnm env)"
fi

# uv shell completions
eval "$(uv generate-shell-completion bash)"
eval "$(uvx --generate-shell-completion bash)"

alias glm="ANTHROPIC_AUTH_TOKEN=super-secret-api-key ANTHROPIC_BASE_URL=\"https://api.z.ai/api/anthropic\" claude"

# starship prompt (must be last - overrides PS1)
command -v starship &>/dev/null && eval "$(starship init bash)"

# End chezmoi template - "dot_bashrc.tmpl"
